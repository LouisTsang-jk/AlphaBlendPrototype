<!DOCTYPE html>
<html>
<head>
    <title>Blend If Effect</title>
    <style>
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px;
        }
        .canvas-wrapper {
            position: relative;
        }
        .checkerboard {
            position: absolute;
            top: 0;
            left: 0;
            z-index: -1;
        }
        .controls {
            width: 100%;
            margin: 20px 0;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div>
            <h3>Original Image</h3>
            <canvas id="inputCanvas"></canvas>
        </div>
        
        <div class="canvas-wrapper">
            <h3>Result with Transparency</h3>
            <canvas id="outputCanvas"></canvas>
            <canvas id="checkerboard" class="checkerboard"></canvas>
        </div>

        <div class="controls">
            <div class="slider-container">
                <label for="threshold">Blend If Threshold:</label>
                <input type="range" id="threshold" min="0" max="255" value="240" step="1">
                <span id="thresholdValue">240</span>
            </div>
            <button id="downloadBtn">Download PNG</button>
            <input type="file" id="fileInput" accept="image/*">
        </div>
    </div>

    <script async src="https://docs.opencv.org/4.10.0/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <script>
        let inputCanvas, outputCanvas, checkerboardCanvas;
        let inputCtx, outputCtx, checkerboardCtx;
        let currentImage = null;

        function onOpenCvReady() {
            console.log('OpenCV.js is ready');
            initializeCanvases();
            setupEventListeners();
            drawCheckerboard();
        }

        function initializeCanvases() {
            inputCanvas = document.getElementById('inputCanvas');
            outputCanvas = document.getElementById('outputCanvas');
            checkerboardCanvas = document.getElementById('checkerboard');
            
            inputCtx = inputCanvas.getContext('2d');
            outputCtx = outputCanvas.getContext('2d');
            checkerboardCtx = checkerboardCanvas.getContext('2d');
        }

        function setupEventListeners() {
            document.getElementById('fileInput').addEventListener('change', handleImageUpload);
            document.getElementById('threshold').addEventListener('input', handleThresholdChange);
            document.getElementById('downloadBtn').addEventListener('click', downloadResult);
        }

        function drawCheckerboard() {
            const width = checkerboardCanvas.width;
            const height = checkerboardCanvas.height;
            const size = 20;
            
            checkerboardCtx.clearRect(0, 0, width, height);
            
            for (let y = 0; y < height; y += size) {
                for (let x = 0; x < width; x += size) {
                    const isEven = (Math.floor(x / size) + Math.floor(y / size)) % 2 === 0;
                    checkerboardCtx.fillStyle = isEven ? '#ffffff' : '#cccccc';
                    checkerboardCtx.fillRect(x, y, size, size);
                }
            }
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        currentImage = img;
                        resizeCanvases(img.width, img.height);
                        drawImage();
                        processImage();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function resizeCanvases(width, height) {
            inputCanvas.width = width;
            inputCanvas.height = height;
            outputCanvas.width = width;
            outputCanvas.height = height;
            checkerboardCanvas.width = width;
            checkerboardCanvas.height = height;
            drawCheckerboard();
        }

        function drawImage() {
            if (currentImage) {
                inputCtx.drawImage(currentImage, 0, 0);
            }
        }

        function processImage() {
            if (!currentImage) return;

            const threshold = parseInt(document.getElementById('threshold').value);
            
            // Read image data using OpenCV
            let src = cv.imread(inputCanvas);
            let dst = new cv.Mat();
            
            // Convert to grayscale
            cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
            
            // Create alpha channel based on threshold
            let channels = new cv.MatVector();
            cv.split(src, channels);
            let alpha = new cv.Mat();
            
            // Create alpha mask based on brightness
            cv.threshold(dst, alpha, threshold, 255, cv.THRESH_BINARY_INV);
            
            // Merge the alpha channel
            channels.set(3, alpha);
            cv.merge(channels, dst);
            
            // Display result
            cv.imshow(outputCanvas, dst);
            
            // Cleanup
            src.delete();
            dst.delete();
            alpha.delete();
            channels.delete();
        }

        function handleThresholdChange(e) {
            document.getElementById('thresholdValue').textContent = e.target.value;
            processImage();
        }

        function downloadResult() {
            if (!currentImage) return;
            
            const link = document.createElement('a');
            link.download = 'result.png';
            link.href = outputCanvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html> 